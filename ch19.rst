
.. _ch19_00:

Маршрутизатор **iplookup**
==========================

Маршрутизатор **iplookup** был написан для выполнения специальных требований в университете Кэмбриджа. По этой причине, он не включен в бинарный файл Exim по умолчанию. Если вы хотите включить его, то вы должны указать

::

    ROUTER_IPLOOKUP=yes

в конфигурационном файле *Local/Makefile*.

**iplookup** маршрутизирует адрес путем посылки его посредством TCP или UDP соединения одному или нескольким особым узлам. Затем узел может возвратить либо тот же самый, либо другой адрес - в действительности переписав адрес получателя в конверте сообщения. Затем новый адрес передается последующим маршрутизатором, или доставка может быть задержана. Так как **iplookup** - только маршрутизатор перезаписи, транспорт(транспортировка) не должен быть определен для этого.

.. index::
   pair: iplookup; optional 

=========  =============  ============  ==============
**hosts**  Use: iplookup  Type: string  Default: unset
=========  =============  ============  ==============

Этот параметр должен быть установлен. Его значение - это список имен узлов, разделенный двоеточиями. Разрешение IP-адресов узлов осуществляется при помощи функций *gethostbyname()* (или *getipnodebyname()* если доступна). Затем адреса пробуются по очереди, до тех пор пока один из них не ответит на запрос. Если ни один узел не ответил, то дальнейшие действия управляются параметром **optional**.

.. index::
   pair: iplookup; optional

============  =============  =============  ==============
**optional**  Use: iplookup  Type: boolean  Default: false
============  =============  =============  ==============

Если **optional** истинна (true), и если ни от одного узла не поступил ответ, то адрес передается следующему маршрутизатору, перекрывая параметр **no_more**. Если **optional** ложна (false), то доставка на этот адрес откладывается.

.. index::
   pair: iplookup; port

========  =============  =============  ==========
**port**  Use: iplookup  Type: integer  Default: 0
========  =============  =============  ==========

Этот параметр должен быть установлен. Он определяет номер TCP- или UDP-порта назначения.

.. index::
   pair: iplookup; protocol

============  =============  ============  ============
**protocol**  Use: iplookup  Type: string  Default: udp
============  =============  ============  ============

Этот параметр может быть установлен либо в udp, либо в tcp для определения какой из этих двух протоколов использовать.

.. index::
   pair: iplookup; query

=========  =============  =============  ==================
**query**  Use: iplookup  Type: string†  Default: see below
=========  =============  =============  ==================

Параметр определяет содержание запроса, посылаемого на удаленные узлы. Значение по умолчанию::

    $local_part@$domain $local_part@$domain

Повтор служит как способ проверки, что ответ на корректный запрос приходит в регистре по умолчанию (см. параметр **response_pattern** ниже).

.. index::
   pair: iplookup; reroute

===========  =============  =============  ==============
**reroute**  Use: iplookup  Type: string†  Default: unset
===========  =============  =============  ==============

Если этот параметр не определен, то адрес измененного маршрута (rerouted address) есть строка байтов, возвращенная удаленным узлом до первого пробела. Она может включать в себя фрагменты, полученные в ответ на параметр **response_pattern**, ссылаясь на них посредством числовых переменных, таких как “$1”, “$2” и т.д. Переменная “$0” ссылается на целую входную строку, независимо от использования шаблона. Во всех случаях, адрес измененного маршрута должен оканчиваться в виде “local_part@domain”.

.. index::
   pair: iplookup; response_pattern

====================  =============  ============  ==============
**response_pattern**  Use: iplookup  Type: string  Default: unset
====================  =============  ============  ==============

Этот параметр может быть определена как регулярное выражение, которое применяется к строке, возвращаемой удаленным узлом. Если шаблон не совпадает с ответом, маршрутизатор отклоняется. Если параметр **response_pattern** не определен, то проверки ответа не происходит, пока запрос не выполнен, в этом случае проверяется что текст, возвращенный после первого пробела, является исходным адресом. Этим проверяется, что полученный ответ является откликом на корректный вопрос. К примеру, если ответ это просто новый домен, то может быть использована следующая конструкция::

    response_pattern = ^([^@]+)$
    reroute = $local_part@$1

.. index::
   pair: iplookup; timeout

===========  =============  ==========  ===========
**timeout**  Use: iplookup  Type: time  Default: 5s
===========  =============  ==========  ===========

Этот определяет время ожидания ответа удаленного узла. Таймаут с этим же значением используется функцией *connect()* в случае TCP-соединения. Параметр к протоколу UDP неприменим.
