
.. _ch30_00:

Транспорт **smtp**
==================

Транспорт **smtp** доставляет сообщения через TCP/IP соединения, используя протокол SMTP или LMTP. Список хостов, для попыток доставки, может быть взят из обрабатываемого адреса (будет установлен маршрутизатором), или явно определён для транспорта. Обработка таймаутов и повторов (смотрите главу :ref:`32 <ch32_00>`) применяется независимо, к каждому IP-адресу.

.. _ch30_01:

Несколько сообщений в одном соединении
--------------------------------------

Отправка нескольких сообщений через одно TCP/IP соединение может быть результатом двух путей:

* Если сообщение содержит более чем **max_rcpt** (смотрите ниже) адресов, которые направляются к одному и тому же хосту, к нему должна быть послана более чем одна копия сообщения. В этой ситуации, несколько копий могут быть посланы в одном запуске транспорта **smtp** через одно TCP/IP соединение. (Что, фактически, и делает Exim, когда ему надо отослать очень много адресов в одном сообщении, также зависит от значения глобального параметра **remote_max_parallel**. Подробности даны в разделе :ref:`45.1 <ch45_01>`.)

* Когда сообщение было успешно доставлено через TCP/IP соединение, Exim смотрит свою БД подсказок (hints), для нахождения - есть ли какие-либо другие сообщения, ожидающие подключения к тому же самому хосту. Если они есть, для одного из них начинается новый процесс доставки, и текущее TCP/IP соединеие передаётся ему. Новый процесс, в свою очередь, может посылать несколько копий, и, возможно, создать ещё один процесс.

Для каждой копии, посланной по одному и тому же TCP/IP соединению, увеличивается счётчик, и, если его значение когда-либо добирается до **connection_max_messages**, по этому подключению сообщения более не посылаются.

.. _ch30_02:

Использование переменных $host и $host_address
----------------------------------------------

В начале запуска транспорта **smtp**, значения $host и $host_address - имя и адрес первого хоста в списке хостов переданном маршрутизатором. Однако, когда транспорт собирается соединяться с заданным хостом, и в то время, пока он соединён с этим хостом, в $host и $host_address содержат данные этого хоста. Также эти значения находятся в силе, когда раскрыты **helo_data**, **hosts_try_auth**, **interface** **serialize_hosts** и различные параметры TLS.

.. _ch30_03:

Использование $tls_cipher и $tls_peerdn
---------------------------------------

В начале запуска транспорта **smtp**, значения $tls_cipher и $tls_peerdn - значения установленные при получении сообщения. Эти значения используются для параметров раскрываемых до создания любых SMTP соединений. Просто, до создания любых соединений, эти две переменные - пусты. Если впоследствии запускается TLS, они устанавливаются в соответствующие значения для исходящего соединения, и эти значения остаются в силе при работе любых аутентификаторов и при раскрытии параметра **authenticated_sender**.

.. _ch30_04:

Частные параметры для **smtp**
------------------------------

Частные параметра транспорта **smtp** таковы:

.. index::
   pair: smtp; address_retry_include_sender 

================================  =========  =============  =============
**address_retry_include_sender**  Use: smtp  Type: boolean  Default: true
================================  =========  =============  =============

Когда доставка откладывается из-за ответа 4хх на команду RCPT, эта комбинация отправителя и получателя задерживается при последующих обработках очереди. Вы можете задержать получателя без ссылки на отправителя (что и делал Exim в более ранних версиях), путём установки **address_retry_include_sender** в ложь. Однако, это может вызвать проблемы с серверами которые регулярно отвечают 4xx на команды RCPT.

.. index::
   pair: smtp; allow_localhost 

===================  =========  =============  ==============
**allow_localhost**  Use: smtp  Type: boolean  Default: false
===================  =========  =============  ==============

Когда хост, заданный в **hosts** или **fallback_hosts** (смотрите ниже), оказывается локальным хостом, или перечислен в **hosts_treat_as_local**, по умолчанию, доставка задерживается. Однако, если установлен параметр **allow_localhost**, Exim продолжает производить доставку. Это должно использоваться лишь в специальных случаях, когда конфигурация гарантирует, что в результате не будет петель (например, порт, на который посылается сообщение, слушает иначе сконфигурированный Exim).

.. index::
   pair: smtp; authenticated_sender

========================  =========  =============  ==============
**authenticated_sender**  Use: smtp  Type: string†  Default: unset
========================  =========  =============  ==============

Когда Exim аутентифицирует клиента, или если истиннен параметр **authenticated_sender_force**, этот параметр устанавливает значение для элемента “AUTH=” в исходящих командах MAIL, замещая любое существующее значение аутентифицированного отправителя. Если раскрытие строки принудительно неудачно, параметр игнорируется. Иные ошибки раскрытия вызывают задержку доставки. Если результат раскрытия - пустая строка, она также игнорируется.

Раскрытие успешно после создания исходящего соединения и запуска TLS, если это требуется. Это означает, что $host, $host_address, $tls_cipher и $tls_peerdn устанавливаются в зависимости от конкретного соединения.

Если SMTP-сессия не аутентифицирована, всё равно происходит раскрытие **authenticated_sender** (и может вызывать задержку доставки, если оно неудачно), но элемент “AUTH=” в команды MAIL не добавляется, исключая случай, когда истинен параметр **authenticated_sender_force**.

Этот параметр позволяет вам использовать транспорт SMTP в режиме LMTP, для доставки почты Cyrus IMAP, и обеспечения надлежащей локальной части как “authenticated sender”, с помощью установки типа::

    authenticated_sender = $local_part
    
Это удаляет необходимость в поддиректориях IMAP, для назначения специальных ACL, чтобы позволить прямую доставку в эти поддиректории.

Поскольку ожидаемое использование - типа описанного для Cyrus (когда домен не используется), нет проверки на синтаксис предоставляемого значения.

.. index::
   pair: smtp; authenticated_sender_force

==============================  =========  =============  ==============
**authenticated_sender_force**  Use: smtp  Type: boolean  Default: false
==============================  =========  =============  ==============

Если этот параметр истинна, значение параметра **authenticated_sender** используется для элемента “AUTH=” в исходящих командах MAIL, когда Exim не аутентифицирован, как клиент.

.. index::
   pair: smtp; command_timeout

===================  =========  ==========  ===========
**command_timeout**  Use: smtp  Type: time  Default: 5m
===================  =========  ==========  ===========

Этот параметр определяет таймаут для получения ответа на отосланную SMTP команду. Также, это значение используется при ожидании начально приветственного сообщения с удалённого хоста. Это значение должно быть ненулевым.

.. index::
   pair: smtp; connect_timeout

===================  =========  ==========  ===========
**connect_timeout**  Use: smtp  Type: time  Default: 5m
===================  =========  ==========  ===========

Этот параметр определяет таймаут для функции *connect()*, устанавливающей TCP/IP вызов к удалённому хосту. Значение нуля разрешает действовать системному таймауту (обычно - несколько минут). Для какого-либо эффекта, это значение должно быть меньше системного таймаута. Однако, на некоторых системах наблюдалось отсутствие какого-либо системного таймаута, поэтому, значение по умолчанию этот параметр - 5 минут, это значение рекомендовано :rfc:`1123`.

.. index::
   pair: smtp; connection_max_messages

===========================  =========  =============  ============
**connection_max_messages**  Use: smtp  Type: integer  Default: 500
===========================  =========  =============  ============

Этот параметр контролирует максимальное число отдельных сообщений, доставляемых через одно TCP/IP соединение. Если значение равно нулю, нет ограничений. В целях тестирования, это значение может быть замещено параметром командной строки **-oB**.

.. index::
   pair: smtp; data_timeout

================  =========  ==========  ===========
**data_timeout**  Use: smtp  Type: time  Default: 5m
================  =========  ==========  ===========

Этот параметр определяет таймаут для передачи каждого блока, в части данных, сообщения. Как результат, - полный таймаут зависит от размера сообщения. Значение не должно быть нулём. Также смотрите параметр **final_timeout**.

.. index::
   pair: smtp; delay_after_cutoff

======================  =========  =============  =============
**delay_after_cutoff**  Use: smtp  Type: boolean  Default: true
======================  =========  =============  =============

Этот параметр управляет там, что происходит когда все удалённые адреса для данного домена были недоступны так долго, что для них были было превышено количество повторов.

По умолчанию, если в следующее время повтора ни один из них не был достигнут, адрес возвращается [#]_ без дальнейших попыток доставки. Другими словами, Exim задерживает повторы IP адресов после финального времени сокращения до достижения нового времени повтора, и поэтому адрес может сорваться без попыток доставки, когда машина недоступна долгое время. Некоторые люди несчастны от этой перспективы, так что...

Если параметр **delay_after_cutoff** установлен в ложь, Exim ведёт себя по другому. Если все адреса проходят их финальное время сокращения, Exim пробует доставить тем адресам, которые не были опробованы с моменты прибытия сообщения. Если они отсутствуют, или все они неудачны, адрес срывается [#]_ . Другими словами, при прибытии нового сообщения задержки не происходит, немедленно пробуются адреса с истёкшим сроком, которые не пробовались с момента прибытия сообщения. Если существует продолжающийся поток сообщений к мёртвым хостам, не заданный параметр **delay_after_cutoff** означает, что будет ещё много попыток доставки на них.

.. index::
   pair: smtp; dns_qualify_single

======================  =========  =============  =============
**dns_qualify_single**  Use: smtp  Type: boolean  Default: true
======================  =========  =============  =============

Если используются параметры **hosts** и **fallback_hosts**, и параметр **gethostbyname** - ложь, то установлен параметр RES_DEFNAMES, резольвера. Для дополнительных деталей, смотрите параметр **qualify_single**, в главе :ref:`17 <ch17_00>`.

.. index::
   pair: smtp; dns_search_parents

======================  =========  =============  ==============
**dns_search_parents**  Use: smtp  Type: boolean  Default: false
======================  =========  =============  ==============

Если используются параметры **hosts** и **fallback_hosts**, и параметр **gethostbyname** - ложь, то установлен параметр RES_DNSRCH, резольвера. Для дополнительных деталей, смотрите параметр **qualify_single**, в главе :ref:`17 <ch17_00>`.

.. index::
   pair: smtp; fallback_hosts

==================  =========  =================  ==============
**fallback_hosts**  Use: smtp  Type: string list  Default: unset
==================  =========  =================  ==============

К этому параметр не применяется раскрытие строк. Аргумент должен быть списком имён хостов, или IP-адресов, разделённых двоеточиями, также, необязательно, включается номер порта, разделитель может быть изменён, как описано в разделе :ref:`6.19 <ch06_19>`. Каждый отдельный элемент списка - тоже самое, что и элемент в установке **route_list** для **manualroute**, как описано в разделе :ref:`20.5 <ch20_05>`.

Аварийные [#]_ хосты, также могут быть определены в маршрутизаторах, которые ассоциированы с обрабатываемыми адресами. Что используется для параметра **hosts** без заданных в транспорте **hosts_override** и **fallback_hosts** лишь если адрес не обладает собственным ассоциированным аварийным списком хостов. В отличие от **hosts**, установка для адреса **fallback_hosts** не замещается путём **hosts_override**. Однако, **hosts_randomize** обращается к спискам аварийных хостов.

Если Exim не может доставить на любой хост для специфического адреса, и ошибки - не постоянные отклонения, адрес помещается в отдельную транспортную очередь, со своим списком хостов, заменённым аварийными хостами, кроме адресов которые марашрутизируются через MX-записи и текущий хост был в изначальном списке MX. В этой ситуации, список аварийных хостов не используется.

Как только завершены нормальные доставки, аварийная очередь доставляется путем повторного запуска тогоже транспорта с новыми списками хостов. Если несколько неудачных адресов имеют одинаковый аварийный хост (и это разрешается параметром **max_rcpt**), посылается одна копия сообщения.

Разрешение имён хостов в аварийном списке контролируется параметром **gethostbyname**, как для параметра **hosts**. Аварийные хосты применяются в обоих случаях, когда список хостов прибывает с адресом, и когда он берётся из **hosts**. Этот параметр обеспечивает средство “use a smart host only if delivery fails” (использовать умные хосты лишь когда неудачна доставка).

.. index::
   pair: smtp; final_timeout

=================  =========  ==========  ============
**final_timeout**  Use: smtp  Type: time  Default: 10m
=================  =========  ==========  ============

Это - таймаут, который применяется когда ожидается заключительная строка, содержащая лишь “.”, завершая сообщение. Это значение не должно быть нулём.

.. index::
   pair: smtp; gethostbyname

=================  =========  =============  ==============
**gethostbyname**  Use: smtp  Type: boolean  Default: false
=================  =========  =============  ==============

Если этот параметр истинна, когда используются параметры **hosts** и/или **fallback_hosts**, имена ищутся используя *gethostbyname()* (или *getipnodebyname()*, когда доступна), вместо использования DNS. Разумеется, эта функция, может, фактически, использовать DNS, но она, также, может консультироваться с другими источниками информации, типа */etc/hosts*.

.. index::
   pair: smtp; gnutls_require_kx

=====================  =========  =============  ==============
**gnutls_require_kx**  Use: smtp  Type: string   Default: unset
=====================  =========  =============  ==============

Этот параметр контролирует механизм обмена ключами при использовании GnuTLS в клиенте Exim. За дополнительными деталями обратитесь к разделу :ref:`39.5 <ch39_05>`.

.. index::
   pair: smtp; gnutls_require_mac

======================  =========  ============  ==============
**gnutls_require_mac**  Use: smtp  Type: string  Default: unset
======================  =========  ============  ==============

Этот параметр контролирует алгоритм MAC при использовании GnuTLS в клиенте Exim. За дополнительными деталями обратитесь к разделу :ref:`39.5 <ch39_05>`.

.. index::
   pair: smtp; gnutls_require_protocols

============================  =========  ============  ==============
**gnutls_require_protocols**  Use: smtp  Type: string  Default: unset
============================  =========  ============  ==============

Этот параметр контролирует протоколы при использовании GnuTLS в клиенте Exim. За дополнительными деталями обратитесь к разделу :ref:`39.5 <ch39_05>`.

.. index::
   pair: smtp; gnutls_compat_mode

======================  =========  =============  ==============
**gnutls_compat_mode**  Use: smtp  Type: boolean  Default: unset
======================  =========  =============  ==============

Этот параметр контролирует когда GnuTLS используется в совместимом режиме в сервере Exim. Это уменьшает безопасность, но улучшает совместимость со старыми реализациями TLS.

.. index::
   pair: smtp; helo_data

=============  =========  =============  ==================
**helo_data**  Use: smtp  Type: string†  Default: see below
=============  =========  =============  ==================

Значение этого параметра раскрывается после установки подключения к другому хосту. Результат используется как аргумент для команды EHLO, HELO, или LHLO, запускающей исходящую SMTP или LMTP сессии. Значение по умолчанию::

    $primary_hostname
   
В процессе раскрытия переменные $host и $host_address устанавливается данные удалённого хоста, и переменные $sending_ip_address и $sending_port устанавливаются в используемые локальный IP адрес и номер порта. Эти переменные могут использоваться для создания различных значений для различных серверов или различных локальных IP адресов. Например, если вы хотите чтобы строка используемая для **helo_data** была получена путём поиска в DNS адреса исходящего интерфейса, вы можете использовать это::

    helo_data = ${lookup dnsdb{ptr=$sending_ip_address}{$value}\
                              {$primary_hostname}

Использование **helo_data** применяется в обоих случаях - при отправке сообщений и при выполнении обратных вызовов (callout).

.. index::
   pair: smtp; hosts

=========  =========  ==================  ==============
**hosts**  Use: smtp  Type: string list†  Default: unset
=========  =========  ==================  ==============

Хосты ассоциированы с адресом при помощи маршрутизатора типа **dnslookup**, который ищёт хосты поиском домена адреса в DNS, или путём **manualroute**, имеющего списки хостов в конфигурации. Однако, почтовые адреса могут быть переданы транспорту **smtp** при помощи любого маршрутизатора, и не все они могут обеспечить ассоциированный список хостов.

Параметр **hosts** задаёт список хостов, используемых если обрабатываемый адрес не имеет связанных с ним ассоциированных хостов. Также, хосты определённые в **hosts** используются при заданного параметра **hosts_override**, независимо от того, заданы ли собственные хосты адреса или нет.

Вначале строка раскрывается, до интерпретации как списка имён хостов, или IP-адресов разделённых двоеточиями, с возможным включением номера порта. Разделитель может быть изменён на что-то иное, чем двоеточие, как описано в разделе :ref:`6.19 <ch06_19>`. Каждый отдельный элемент списка - тоже самое, что и элемент в установке **route_list** для **manualroute**, как описано в разделе :ref:`20.5 <ch20_05>`. Однако, отметьте, что средство “/MX”, маршрутизатора **manualroute**, тут недоступно.

Если раскрытие неудачно, доставка задерживается. Исключая ошибку, вызванную неспособностью завершить поиск, ошибка записывается в лог паники, также как и в главный лог. Имена хостов ищутся или путём непосредственного поиска записи адреса в DNS, или путём вызова *gethostbyname()* (или *getipnodebyname()*, когда она доступна), в зависимости от установки параметра **gethostbyname**. Когда Exim собран с поддержкой IPv6, если хост, который ищется в DNS, имеет оба адреса - IPv4 и IPv6, используются оба типа адреса.

В процессе доставки, хосты пробуются в порядке подчиняющемся их статусу повтора, если не задан параметр **hosts_randomize**.

.. index::
   pair: smtp; hosts_avoid_esmtp

=====================  =========  ================  ==============
**hosts_avoid_esmtp**  Use: smtp  Type: host list†  Default: unset
=====================  =========  ================  ==============

Этот параметр - для использования с кривыми хостами, которые объявляют средства ESMTP (например PIPELINING), и, затем, не в состоянии осуществить их должным образом. Когда хост совпадает с **hosts_avoid_esmtp**, Exim посылает HELO, а не EHLO, в начале сеанса SMTP. Это означает, что не могут использоваться какие бы то ни было ESMTP средства, типа AUTH, PIPELINING, SIZE, и STARTTLS.

.. index::
   pair: smtp; hosts_avoid_pipelining

==========================  =========  ================  ==============
**hosts_avoid_pipelining**  Use: smtp  Type: host list†  Default: unset
==========================  =========  ================  ==============

Exim не использует расширение SMTP PIPELINING когда производит доставку на любой хост из этого списка, даже если хост объявлял поддержку PIPELINING.

.. index::
   pair: smtp; hosts_avoid_tls

===================  =========  ================  ==============
**hosts_avoid_tls**  Use: smtp  Type: host list†  Default: unset
===================  =========  ================  ==============

Exim не пытается начать TLS-сессию, когда происходит доставка на любой хост совпадающий с этим списком. Для получения дополнительных деталей о TLS, смотрите главе :ref:`39 <ch39_00>`.

.. index::
   pair: smtp; hosts_max_try

=================  =========  =============  ==========
**hosts_max_try**  Use: smtp  Type: integer  Default: 5
=================  =========  =============  ==========

Этот параметр ограничивает число IP-адресов, которые пробуются для любой одной доставки, в случае когда происходят временные ошибки доставки. Раздел :ref:`30.5 <ch30_05>` описывает её использование, и зачем она нужна.

.. index::
   pair: smtp; hosts_max_try_hardlimit

===========================  =========  =============  ===========
**hosts_max_try_hardlimit**  Use: smtp  Type: integer  Default: 50
===========================  =========  =============  ===========

Это - дополнительная проверка на максимальное число IP-адресов, которые Exim пробует для любой одной доставки. Раздел :ref:`30.5 <ch30_05>` описывает её использование, и зачем она нужна.

.. index::
   pair: smtp; hosts_nopass_tls

====================  =========  ================  ==============
**hosts_nopass_tls**  Use: smtp  Type: host list†  Default: unset
====================  =========  ================  ==============

Для любых хостов, которые совпадают с этим списком, соединение на котором была начата TLS-сессия, не будет передаваться новому процессу доставки для посылки иного сообщения в той же самой сессии. Для объяснений, когда это может быть необходимо, смотрите раздел :ref:`39.10 <ch39_10>`.

.. index::
   pair: smtp; hosts_override

==================  =========  =============  ==============
**hosts_override**  Use: smtp  Type: boolean  Default: false
==================  =========  =============  ==============

Если этот параметр установлен, и, также, установлен параметр **hosts**, то любые хосты присоединённые к адресу игнорируются, и вместо них всегда используются хосты заданные в параметре **hosts**. Этот параметр не применяется к **fallback_hosts**.

.. index::
   pair: smtp; hosts_randomize

===================  =========  =============  ==============
**hosts_randomize**  Use: smtp  Type: boolean  Default: false
===================  =========  =============  ==============

Если этот параметр установлен, и, или список хостов взят из параметра **hosts** или **fallback_hosts**, или хосты предоставленные маршрутизатором не были получены из MX-записей (это включает аварийные хосты из маршрутизатора), и не были рандомизированы [#]_ маршрутизатором, то порядок опробования хостов рандомизируется каждый раз при запуске транспорта. Перемешивание порядка списка хостов может использоваться для грубого распределения нагрузки.
   
Когда параметр **hosts_randomize** - истинна, список хостов может быть разбит на группы, порядок которых перемешивается отдельно. Это позволяет установить MX-like поведение. Границы между группами обозначены элементом, который просто “+” в списке хостов. Например::

    hosts = host1:host2:host3:+:host4:host5
    
Порядок трёх первых и порядок последних двух хостов перемешивается для каждого использования, но первые три всегда завершаются до двух последних. Если параметр **hosts_randomize** не установлена, элемент списка “+” - игнорируется.

.. index::
   pair: smtp; hosts_require_auth

======================  =========  ================  ==============
**hosts_require_auth**  Use: smtp  Type: host list†  Default: unset
======================  =========  ================  ==============

Этот параметр предоставляет список серверов, для которых должна произойти успешная аутентификация до того, как Exim попробует передать сообщение. Если аутентификация неудачна для серверов которые не в этом списке, Exim пробует отослать без аутентификации. Если аутентифкация неудачна для одного из серверов в списке, - доставка задерживается. Эта временная ошибка обнаружима в правилах повторов, таким образом, она может быть превращена жёсткую ошибку, если это требуется. Также смотрите параметр **hosts_try_auth** и главу :ref:`33 <ch33_00>` - для получения дополнительных деталей о аутентификации.

.. index::
   pair: smtp; hosts_require_tls

=====================  =========  ================  ==============
**hosts_require_tls**  Use: smtp  Type: host list†  Default: unset
=====================  =========  ================  ==============

Exim будет настаивать на использовании сессии TLS, когда доставляет к любому хосту который совпадает с этим списком. Смотрите главу :ref:`39 <ch39_00>`, для получения дополнительных деталей о TLS. 

.. note:: Этот параметр затрагивает лишь исходящую почту. Для применения TLS ко входящим сообщениям, используйте соответствующую ACL.

.. index::
   pair: smtp; hosts_try_auth

==================  =========  ================  ==============
**hosts_try_auth**  Use: smtp  Type: host list†  Default: unset
==================  =========  ================  ==============

Этот параметр предоставляет список серверов, которым Exim пытается аутентифицироваться, когда соединяется как клиент, если эти сервера объявляли о поддержке аутентификации. Если аутентификация неудачна, Exim пробует передать сообщение неаутентифицировавшись. Также смотрите параметр **hosts_require_auth** и главу :ref:`33 <ch33_00>` - для получения дополнительных деталей о аутентификации.

.. index::
   pair: smtp; interface

=============  =========  ==================  ==============
**interface**  Use: smtp  Type: string list†  Default: unset
=============  =========  ==================  ==============

Этот параметр определяет, какие интерфейсы будут использоваться при создании исходящего SMTP-вызова. Значение - IP адрес, а не имя интерфейса, типа ``xl0``. Не перепутайте с адресом интерфейса который используется при получении сообщения, находящегося в $received_ip_address, ранее известной как $interface_address. Имя было изменено для минимизации путаницы с адресом исходящего интерфейса. Нет переменной которая содержит адрес исходящего интерфейса, по причине что если он не задан этим параметром - его значение неизвестно.

В процессе раскрытия параметра **interface** переменные $host и $host_address ссылаются на хост, к которому будет производиться подключение. Принудительная неудача раскрытия, или результат в виде пустой строки, вызывают игнорирование этого параметра. Иначе, после раскрытия, строка должна быть списком IP-адресов, по умолчанию разделённых двоеточиями, но разделитель может быть изменён обычным способом. Например::

    interface = <; 192.168.123.123 ; 3ffe:ffff:836f::fe86:a061
      
Первый интерфейс корректного типа (IPv4 или IPv6) - используется для исходящего соединения. Если ни один из них не является интерфейсом правильного типа, параметр игнорируется. Если параметр **interface** не установлен, или игнорируется, то системные IP-функции выбирают, какой интерфейс использовать, если у хоста их более одного.

.. index::
   pair: smtp; keepalive

=============  =========  =============  =============
**keepalive**  Use: smtp  Type: boolean  Default: true
=============  =========  =============  =============

Этот параметра контролирует установку SO_KEEPALIVE на исходящих сокетах соединения TCP/IP. Когда она установлена, она заставляет ядро периодически исследовать неактивные соединения, путём отправки пакета со “старым” номером последовательности. Другой конец подключения должен послать подтверждение, если с подключением всё в порядке, или сброс, если подключение было прервано. Причина этого в том, что оказывается благоприятное воздействие освобождения некоторых типов подключений, которые могут “застрять”, когда удалённый хост отключается, не разрывая TCP/IP соединение должным образом. Механизм “keepalive” может занять несколько часов, для обнаружения недостижимых хостов.

.. index::
   pair: smtp; lmtp_ignore_quota

=====================  =========  =============  ==============
**lmtp_ignore_quota**  Use: smtp  Type: boolean  Default: false
=====================  =========  =============  ==============

Если этот параметр истинна, когда параметр **protocol** установлен в **lmtp**, строка ``IGNOREQUOTA`` добавляется у команде RCPT, при условии, что LMTP-сервер информировал о поддержке ``IGNOREQUOTA`` в его ответе на команду LHLO.

.. index::
   pair: smtp; max_rcpt

============  =========  =============  ============
**max_rcpt**  Use: smtp  Type: integer  Default: 100
============  =========  =============  ============

Этот параметр ограничивает число команд RCPT, которые посылаются в одной SMTP-транзакции. Каждый установленный адрес обрабатывается независимо, и, таким образом, может вызывать параллельные подключения к одному и тому же хосту, если это разрешается параметром **remote_max_parallel**.

.. index::
   pair: smtp; multi_domain

================  =========  =============  ============
**multi_domain**  Use: smtp  Type: boolean  Default: true
================  =========  =============  ============

Когда этот параметр установлен, транспорт **smtp** может обрабатывать множество адресов, содержащих смесь различных доменов, если все они резольвятся в один и тот же список хостов. Выключение параметр ограничивает транспорт обработкой лишь одного домена одновременно. Это полезно, если вы хотите использовать $domain в раскрытии для транспорта, поскольку она установлена лишь когда один домен вовлечён в удалённую доставку.

.. index::
   pair: smtp; port

========  =========  =============  ==================
**port**  Use: smtp  Type: string†  Default: see below
========  =========  =============  ==================

Этот параметр определяет TCP/IP порт на сервере, с котырым соединяется Exim.

.. note:: Не перепутайте её с портом который используется при приёме сообщения, $received_port, ранее известной как $interface_port. Имя изменено для минимизации ошибок с исходящим портом. Переменная содержащая исходящий порт - остутствует.

Если значение параметра начинается с цифры, оно берётся как номер порта; иначе, оно ищется с использованием *getservbyname()*. Обычно, значение по умолчанию - **smtp**, но, если протокол установлен как **lmtp**, значение по умолчанию - **lmtp**. Если раскрытие неудачно, или если не может быть найден номер порта, доставка задерживается.

.. index::
   pair: smtp; protocol

============  =========  ============  =============
**protocol**  Use: smtp  Type: string  Default: smtp
============  =========  ============  =============

Если этот параметр установлен в **lmtp** вместо **smtp**, значение по умолчанию для параметра **port** изменяется на **lmtp**, и транспорт оперирует протоколом LMTP (:rfc:`2033`), вместо SMTP. Этот протокол иногда используется для локальных доставок в закрытое хранилища сообщений. Exim, также, поддерживает выполнение LMTP через трубу к локальному процессу - смотрите главу :ref:`28 <ch28_00>`.

.. index::
   pair: smtp; retry_include_ip_address

============================  =========  =============  =============
**retry_include_ip_address**  Use: smtp  Type: boolean  Default: true
============================  =========  =============  =============

Exim, обычно, включает оба - имя хоста и IP-адрес в ключ, создаваемый для индексирования данных повторов, после временной неудачи доставки. Это означает, что когда один или несколько IP-адресов для хоста неудачны, он проверяет их периодически (управляемый правилами повторов), но использование других IP-адресов - не затрагивается.

Однако, в некоторых окружающих средах dialup-хостов, назначается другой адрес при каждом соединении. В этой ситуации, использование IP-адреса как части ключа повторов приводит к нежелательным результатам. Установка этого параметра в ложь, заставляет Exim использовать только имя хоста. Обычно, это должно делаться на отдельном **smtp** транспорте, устанавливаемом специально для обработки dialup-хостов.

.. index::
   pair: smtp; serialize_hosts

===================  =========  ================  ==============
**serialize_hosts**  Use: smtp  Type: host list†  Default: unset
===================  =========  ================  ==============

Поскольку Exim работает в распределённой манере, если несколько сообщений для одного хоста прибывают одновременно, может произойти более одного подключения к удалённому хосту. Обычно, это не проблема, кроме случаев, когда между хостами медленная связь. В этом случае, может быть полезным ограничить Exim одним соединением одновременно. Это может быть сделано путём установки параметра **serialize_hosts**, чтобы она совпадала с этими хостами.

Exim осуществляет упорядочивание посредством базы данных подсказок (hints), в которую вносятся записи каждый раз, когда процесс соединяется с одним из ограниченных хостов. Запись удаляется после завершения соединения. Очевидно, есть возможность для оставления ложных записей, если происходит системный или программный сбой. Для принятия мер против этого, Exim игнорирует любые записи старше шести часов.

Если вы устанавливаете этот вид упорядочивания, вы, также, должны принять меры для удаления БД подсказок (hints) при каждой перезагрузке системы. Имена файлов начинаются с *misc*, и они хранятся в директории *spool/db*. Могут быть один, или два файла, в зависимости от типа используемой DBM. Те же самые файлы используются для упорядочивания ETRN.

.. index::
   pair: smtp; size_addition

=================  =========  =============  =============
**size_addition**  Use: smtp  Type: integer  Default: 1024
=================  =========  =============  =============

Если удалённый сервер SMTP указывает, что он поддерживает параметр SIZE в команде MAIL, Exim использует её для передачи размера сообщения, в начале SMTP-транзакции. Этим параметром добавляется значение **size_addition** к передаваемому значению, для учёта заголовков и другого текста, который может быть добавлен, в процессе доставки, конфигурационными параметрами, или в транспортном фильтре. Может возникнуть необходимость увеличить это значение, если к сообщениям добавляется много текста.

Альтернативно, если установлено отрицательное значение параметра **size_addition**, оно вообще отключает использование параметра SIZE.

.. index::
   pair: smtp; tls_certificate

===================  =========  =============  ==============
**tls_certificate**  Use: smtp  Type: string†  Default: unset
===================  =========  =============  ==============

Значение этого параметра должно быть абсолютным путём к файлу, содержащему клиентский сертификат, для возможного использования при посылке сообщения через зашифрованное соединение. В процессе раскрытия, значения $host и $host_address устанавливаются в имя и адрес сервера. Смотрите главу :ref:`39 <ch39_00>`, для получения дополнительных деталей о TLS.

.. note:: Этот параметр должен быть задан, если вы хотите, чтобы Exim мог использовать TLS-сертификаты при отправке сообщений как клиент. Глобальный параметр, с тем же самым именем, задаёт сертификат для Exim`a как сервера; не предполагается, автоматически, что тот же самый сертификат должен использоваться при работе Exim`a как клиента.

.. index::
   pair: smtp; tls_crl

===========  =========  =============  ==============
**tls_crl**  Use: smtp  Type: string†  Default: unset
===========  =========  =============  ==============

Этот параметр определяет список аннулированных сертификатов. Раскрытое значение должно быть именем файла, содержащего CRL в формате PEM.

.. index::
   pair: smtp; tls_privatekey

==================  =========  =============  ==============
**tls_privatekey**  Use: smtp  Type: string†  Default: unset
==================  =========  =============  ==============

Значение этого параметра должно быть абсолютным путём к файлу, содержащему частный ключ клиента. Это используется при отправке сообщения через шифрованное соединение, используя клиентский сертификат. В процессе раскрытия, значения $host и $host_address устанавливаются в имя и адрес сервера. Если этот параметр не задан, или раскрытие принудительно неудачно, или результат - пустая строка, предполагается, что частный ключ находится в том же файле, что и сертификат. Смотрите главу :ref:`39 <ch39_00>`, для получения дополнительных деталей о TLS.

.. index::
   pair: smtp; tls_require_ciphers

=======================  =========  =============  ==============
**tls_require_ciphers**  Use: smtp  Type: string†  Default: unset
=======================  =========  =============  ==============

Значение этого параметра должно быть списком разрешённых наборов шифров, для использования при установке исходящего шифрованного соединения. (Есть глобальный параметр, с тем же самым именем, для контроля входящих соединений.) В процессе раскрытия, значения $host и $host_address устанавливаются в имя и адрес сервера. Смотрите главу :ref:`39 <ch39_00>`, для получения дополнительных деталей о TLS; отметьте, что этот параметр используется по разному OpenSSL и GnuTLS (смотрите разделы :ref:`39.4 <ch39_04>` и :ref:`39.5 <ch39_05>`). Для GnuTLS, порядок шифров - предпочтительный порядок.

.. index::
   pair: smtp; tls_tempfail_tryclear

=========================  =========  =============  =============
**tls_tempfail_tryclear**  Use: smtp  Type: boolean  Default: true
=========================  =========  =============  =============

Когда хост сервера не находится в **hosts_require_tls**, и есть проблема в установке TLS-сессии, этот параметр определяет, должен ли Exim пытаться доставить не шифрованное соединение. Если она установлена в ложь, доставка к текущему хосту задержана; если есть другие хосты - пробуются они. Если этот параметр установлен в истину, Exim пытается доставить не шифрованное сообщение, после 4xx ответа на STARTTLS. Также, если STARTTLS принят, но последующие переговоры TLS неудачны, Exim закрывает текущее соединение (поскольку оно находится в неопределённом состоянии), открывает новое, к тому же самому хосту, и пытается осуществить чистую [#]_ доставку.

.. index::
   pair: smtp; tls_verify_certificates

===========================  =========  =============  ==============
**tls_verify_certificates**  Use: smtp  Type: string†  Default: unset
===========================  =========  =============  ==============

Значение этого параметра должно быть абсолютным путём к файлу, содержащему разрешённые серверные сертификаты, для использования при установке шифрованного подключения. Альтернативно, если вы используете OpenSSL, вы должны установить **tls_verify_certificates** в имя директории, содержащей файлы сертификатов. Это не работает с GnuTLS; этот параметр должен быть установлен в имя одного файла, если вы используете GnuTLS. В процессе раскрытия, значения $host и $host_address устанавливаются в имя и адрес сервера. Смотрите главу :ref:`39 <ch39_00>`, для получения дополнительных деталей о TLS.


.. _ch30_05:

Как ограничить число хостов используемых для проверки
-----------------------------------------------------

Есть два параметра, которые связаны с числом хостов, которые проверяются при SMTP доставке. Это **hosts_max_try** и **hosts_max_try_hardlimit**.

Параметр **hosts_max_try** ограничивает число хостов, которые пробуются за за одну доставку. Однако, несмотря на термин “хост” в её названии, параметр, фактически, применяется независимо к каждому IP-адресу. Другими словами, многоадресные [#]_ хосты обрабатываются как несколько независимых хостов, точно так же как и для повторов.

Многие из больших :abbr:`ISP` [#]_ имеют много MX-записей, часто указывающих на многоадресные хосты. Как результат, список дюжины и более IP-адресов может быть создан в результате маршрутизации одного из этих доменов.

Пробовать каждый отдельный адрес в таком длинном списке - не самая разумная идея; если несколько адресов вверху списка неудачны, разумно предположить, что существует какая-то проблема, затрагивающая их все. Грубо говоря, значение **hosts_max_try** - максимальное число, пробуемое до задержки доставки. Однако, логика не может быть простой.

Во-первых, IP-адреса пропускаются, поскольку не пришло их время повтора, и кроме того, адреса, время повтора которых не подошло, также не подсчитываются. Это означает, что когда некоторые адреса доходят до их времени повтора, может быть попробовано более одного значения **hosts_max_try**. Причина такого поведения заключается в необходимости гарантировать, что все IP-адреса рассмотрены до таймаута почтового адреса (но, смотрите ниже, для исключений).

Во-вторых, когда достигнут предел **hosts_max_try**, Exim просматривает вниз список хостов, чтобы найти есть ли последующие хосты с иным (более высоким) значением MX. Если они есть, этот хост рассматривается следующим, и текущий IP-адрес используется, но не подсчитывается. Это поведение - помощь в случае, когда домен с правилами повтора, которые почти никогда не задерживают никакие хосты, как - сейчас будет объяснено:

Рассмотрите случай длинного списка хостов, с одним значением MX, и нескольких с более высоким значением MX. Если **hosts_max_try** - маленькое (значение по умолчанию - 5), вначале будут опробованы лишь несколько хостов вверху списка. С правилами по умолчанию повторов, определяющими увеличивающееся время повтора, в конечном счёте, пробуются более высокие MX-хосты, после того, как те, что наверху списка пропущены, поскольку они не достигли их времени повтора.

Однако, это, - обычная практика для помещения короткого фиксированного времени повтора в доменах крупных ISP, на том основании, что что их сервера редко лежат очень долго. К сожалению, они - как раз те домены, которые имеют тенденцию к резольвингу в длинные списки хостов. Короткое время повтора - что самые самые маленькие MX-хосты пробуются чаще всего. Попытки могут быть в различном порядке, из-за случайной сортировки, но без специальной проверки MX, высшие MX-хосты бы никогда не пробовались, до тех пор, пока все низшие MX-хосты имеют таймаут (который может быть несколько дней), поскольку всегда есть каки-либо низшие MX-хосты, с наступившим временем повтора. Со специальной проверкой, Exim рассматривает по крайней мере один IP-адрес от каждого значения MX, при каждой попытке доставки, даже если уже был достигнут предел **hosts_max_try**.

Вышеупомянутая логика означает, что **hosts_max_try** - не является жёстким пределом, и в частности, обычно, Exim пробует все адреса, до таймаута адреса электронной почты. Когда **hosts_max_try** была осуществлена, это казалось разумной вещью. Однако, недавно, некоторые сумасшедшие конфигурации DNS были установлены с сотнями IP-адресов для некоторых доменов. Это, действительно, может занять очень длительное время для таймаута адресов, в этих случаях.

Параметр **hosts_max_try_hardlimit** была добавлена для помощи при таких проблемах. Exim никогда не пробует больше этого числа IP-адресов; если он достигает этого предела, и у всех них был таймаут, почтовый адрес срывается [#]_ , даже несмотря на то, что не все возможные IP-адреса были попробованы.


.. [#] в виде рикошета - прим. lissyara
.. [#] генерится рикошет - прим. lissyara
.. [#] резервные, чтоли... - прим. lissyara
.. [#] изменён их порядок, случайным образом - прим. lissyara
.. [#] видимо - нешифрованную - прим. lissyara
.. [#] тут применялось другое словечко - multihomed, но думаю, так будет ясней - прим. lissyara
.. [#] Internet Service Provider, провайдеров интернета - прим. lissyara
.. [#] генерится рикошет - прим. lissyara
