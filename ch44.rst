
.. _ch44_00:

Обработка сообщения
===================

Exim выполняет различные преобразования адресов отправителей и получателей для всех обрабатываемых сообщений, и, также, строк заголовков. Некоторые из них - необязательны и настраиваемые, тогда как другие присутствуют всегда. Вся эта обработка, исключая перезапиь как результат маршрутизации, и добавления/удаления строк заголовков при доставке, происходит при приёме сообщения, до его помещения в очередь Exim'a.

Часть автоматической обработки, по умолчанию, происходит лишь для “порожденных локально” (“locally-originated”) сообщений. Это прилагательное используется для описания сообщений которые не были переданы через TCP/IP, а переданы процессу Exim'a на его стандартный ввод. Оно включает случай интерактивного “локального SMTP”, который устанавливается параметром **-bs**, командной строки.

E. note:: Сообщения переданные через TCP/IP на интерфейсе обратной петли (*127.0.0.1* или *::1*), не рассматриваются как поражденные локально. Exim никогда не обрабатывает особым образом интерфейс локальной петли.

  Если вы хотите обработать интерфейс локальной петли особым образом, вы должны гарантировать, что существуют соответствующие записи в ваших ACL.

.. _ch44_01:

Режим передачи для нелокальных сообщений
----------------------------------------

Происходящую автоматически обработку для локально порожденных сообщений (если не установлен параметр **suppress_local_fixups**), также можно затребовать для сообщений полученных по TCP/IP. Термин “режим передачи” (“submission mode”) используется для описания этого состояния. Режим передачи устанавливается при помощи модификатора

::

    control = submission

в MAIL, RCPT, или ACL до данных, для входящего сообщения (смотрите разделы :ref:`40.19 <ch40_19>` и :ref:`40.20 <ch40_20>`). Он заставляет Exim обработать сообщение как переданное локально, и, обычно, используется для когда источник сообщения известен как MUA, работающий на клиентском хосте (в противоположность MTA). Например, для установки режима передачи для сообщений приходящих на IPv4 интерфейсе обратной петли, вы могли включить следующее в MAIL ACL::

    warn  hosts = 127.0.0.1
          control = submission

Есть некоторые параметры, которые могут использоваться когда установлен режим передачи. Слэш используется для разделения параметров. Например::

    control = submission/sender_retain

Указание **sender_retain** имеет эффект установки параметра **local_sender_retain** равным “true” и **local_from_check** равной “false” для текущего входящего сообщения. Первая из них позволяет сохранять существующий заголовок “Sender:”, второй параметр подавляет проверку заголовка “From:” на соответствие с аутентифицированным пользователем. С этим параметром Exim по прежнему добавляет до сообщения заголовки “Date:” и “Message-ID:”, если они отсутствуют, но не пробует проверить отправителя из строк заголовка.

Когда **sender_retain** не установлен, настройки режима передачи могут задавать домен, который будет использоваться при создании заголовков “From:” или “Sender:”. Например::

    control = submission/domain=some.domain

Домен может быть пустым. Как это значение используется - описано в разделах :ref:`44.11 <ch44_11>` и :ref:`44.16 <ch44_16>`. Также, есть параметр **name**, которая позволяет вам задать полное имя пользователя для включения в создаваемые заголовки “Sender:” и “From:”. Например::

    accept authenticated = *
           control = submission/domain=wonderland.example/\
                                name=${lookup {$authenticated_id} \
                                lsearch {/etc/exim/namelist}}

Поскольку имя может содержать любые символы, включая слэши, параметр **name** должна быть дана последней. Оставшаяся строка используется как имя. Для примера выше, если */etc/exim/namelist* содержит::

    bigegg:  Humpty Dumpty

тогда, когда отправитель аутентифицирован как *bigegg*, созданная строка “Sender:” была бы::

    Sender: Humpty Dumpty <bigegg@wonderland.example>

По умолчанию, режим передачи принудительно ставит путь возврата в тот же адрес, что используется для создания заголовка “Sender:”. Однако, если задана **sender_retain**, путь возврата также остаётся неизменным.

.. note:: изменения вызванные режимом передачи вступают в силу после ACL перед данными. Это означает, что любые проверки отправителя выполненные перед адресными привязками используют ненадёжный адрес отправителя заданный пользователем, а не надёжным адресом отправителя заданным режимом передачи. Хотя это несколько неожиданно, в действительности это означает, что вы можете настроить проверки ACL на определение что пользователь пробует сфабриковать иной адрес.

.. _ch44_02:

Завершения строк
----------------

:rfc:`2821` задаёт, что CRLF (два символа: возврат каретки, сопровождаемый переводом строки) - конец сообщений передаваемых через интернет, используя SMTP через TCP/IP. Однако, в отдельных операционных системах, используются иные соглашения. Например, UNIX-подобные системы используют лишь LF, но иные используют CRLF или просто CR.

Exim был разработан для UNIX-подобных систем, и внутренне, он сохраняет сообщения используя системное соглашение единственного LF как терминатора строки. Получая сообщение, все концы строк переводятся в этот стандартный формат. Изначально, предполагалось, что программы передающие сообщения напрямую к MTA, внутри операционной системы, будут использовать системные соглашения. Опыт показал, что это не так; например, существуют UNIX-приложения, которые в этом случае используют CRLF. Поэтому, и для совместимости с другими MTA, способы, которыми Exim обрабатывает концы строк для всех сообщений, на данный момент, - таковы:

* LF, которму не предшествовал CR - обрабатывается как завершение строки.
* CR - обрабатывается как конец строки; если сразу за ним идёт LF, LF игнорируется.
* Последовательность “CR, точка, CR” не завершает входящее SMTP-сообщение, ни локальное сообщение, в случае когда строка содержащая лишь точку - терминатор.
* Если в стрке заголовка найден лишь CR, после завершения строки добавляется дополнительное пустое пространство, чтобы не завершить строку заголовка. Рассуждения таковы, что пустые CR в заголовках, наиболее вероятно, ошибки, или люди пробующие игоать в глупые игры.
* Если первая строка заголовка в сообщении завершается CRLF, последующие пустые LF в строке заголовка обрабатывается точно также как и пустой CR в строке заголовка.

.. _ch44_03:

Неквалифицированные адреса
--------------------------

По умолчанию, Exim ожидает, что каждый, получаемый с внешнего хоста, адрес конверта, будет полностью квалифицирован (с доменным именем). Неквалифицированные адреса вызывают отрицательные ответы на команды SMTP. Однако, поскольку SMTP используется для как средство транспортировки сообщений от MUA работающих на персональных рабочих станциях, иногда требуется принимать неквалифицированные адреса от специфических хостов или IP-сетей.

У Exim'a есть два параметра, которые раздельно управляют тем, какие хосты могут посылать неквалифицированные адреса отправителей или получателей в SMTP-командах, именуемые **sender_unqualified_hosts** и **recipient_unqualified_hosts**. В обоих случаях, если принимаются неквалифицированные адреса, они квалифицируются путём добавления значения **qualify_domain** или **qualify_recipient**, соответственно.

Неквалифицированные адреса в строках заголовков, автоматически квалифицируются для порожденных локально сообщений, если в командной строке не задан параметр **-bnq**. Для сообщений принятых по SMTP, неквалифицированные адреса, в заголовках, квалифицируются лишь если в SMTP-командах разрешены неквалифицированные адреса. Другими словами, этой квалификацией также управляют путём **sender_unqualified_hosts** и **recipient_unqualified_hosts**.

.. _ch44_04:

Строка “From” UUCP
------------------

Сообщения приходящие из UUCP (и некоторых других приложений), часто, начинаются со строки содержащей отправителя конверта и штамп времени, после слова “From”. Примеры двух обычных форматов::

    From a.oakley@berlin.mus Fri Jan  5 12:35 GMT 1996
    From f.butler@berlin.mus Fri, 7 Jan 97 14:00:00 GMT

Эта строка предшествует строкам заголовков, соответствующим :rfc:`2822`. Для совместимости с Sendmail, Exim распознаёт такие строки как начало сообщения переданного через командную строку (т.е. на стандартном вводе). Он не распознаёт такие строки во входящих сообщениях, если посылающий хост не совпадает с **ignore_fromline_hosts**, или не использовался параметр **-bs** для локального сообщения, при установленной **ignore_fromline_hosts**. Распознание управляется регулярным выражением, которое задано параметром **uucp_from_pattern**, чьё значение по умолчанию совпадает с двумя частыми случаями, показанными выше, и помещает адреса следующие за “From” в “$1”.

Когда пользователь, вызывающий Exim для не-SMTP сообщения содержащего строку “From” - доверенный пользователь, адрес отправителя сообщения конструируется путём раскрытия содержимого **uucp_sender_address**, чьё значение по умолчанию - “$1”. Затем оно разбирается как адрес по :rfc:`2822`. Если в нём нет домена, локальная часть квалифицируется с **qualify_domain**, если оно - не пустая строка. Однако, если используется параметр командной строки **-f**, она перезадаёт строку “From”.

Если Exim вызывает не доверенный пользователь, строка “From” распознаётся, но адрес отправителя не изменяется. Для входящих SMTP сообщений с разрешённой строкой “From”, применяется этот же случай.

Распознаётся лишь одна строка “From”. Если их больше одной, вторая обрабатывается как строка данных, которая начинает тело сообщения, поскольку она - не допустимая строка заголовка. Также это происходит если строка “From” представлена во входящем SMTP-сообщении от источника, которму его не разрешено посылать.

.. _ch44_05:

Строки заголовков **Resent-**
-----------------------------

:rfc:`2822` создаёт условия для добавления в сообщение строк заголовков начинающихся со строки “Resent-”, когда оно пересылается оригинальным получателем ещё кому-то. Эти заголовки - “Resent-Date:”, “Resent-From:”, “Resent-Sender:”, “Resent-To:”, “Resent-Cc:”, “Resent-Bcc:” и “Resent-Message-ID:”. В RFC говорится:

*Повторно посланные поля являются строго информационными. Они НЕ ДОЛЖНЫ использоваться в нормальной обработке ответов, или других подобных автоматических действиях для сообщений.*

Этим оставляются несколько неопределённым, насколько затронуты другие действия обработки, типа перезаписи адресов. Exim обрабатывает строки заголовков **Resent-** следующим образом:
      
* Строка “Resent-From:” - содержит лишь логин передающего пользователя, и автоматически перезаписывается точно таким же способом как “From:” (смотрите ниже).

* Если есть правило перезаписи для специфической строки заголовка, оно, также применяется к заголовку **Resent-**, того же типа. Например, правило перезаписывающее “From:” также перезапишет “Resent-From:”.

* Для локальных сообщений, если из ввода удалён “Sender:”, также удаляется  и “Resent-Sender:”.
  
* Для локально переданных сообщений, если есть какая либо строка заголовка **Resent-**, но нет “Resent-Date:”, “Resent-From:” или “Resent-Message-Id:”, они добавляются по мере необходимости. Это - содержимое “Resent-Message-Id:” (а не “Message-Id:”), которое включается в строки логов в этом случае.

* Логика для добавления “Sender:” - дублируется для “Resent-Sender:”, когда присутствует любой заголовок **Resent-**.

.. _ch44_06:

Строка заголовка “Auto-Submitted:”
----------------------------------

Каждый раз, когда Exim создает автоответ, рикошет, или предупреждающее сообщение о задержке, он включает строку заголовка::

    Auto-Submitted: auto-replied

.. _ch44_07:

Строка заголовка “Bcc:”
-----------------------

Если Exim вызывается с параметром **-t**, чтобы получить адреса получателей из заголовков сообщений, он удаляет любые строки заголовков “Bcc:” которые могут существовать (после извлечения их адресов). Если **-t** не представлена в командной строке, любые существующие “Bcc:” не удаляются.

.. _ch44_08:

Строка заголовка “Date:”
------------------------

Если порожденное локально сообщение, или сообщение в режиме передачи, не имеет заголовка “Date:”, Exim добавляет один, используя текущую дату и время, если не была определен параметр **suppress_local_fixups**.

.. _ch44_09:

Строка заголовка “Delivery-date:”
---------------------------------

Заголовок “Delivery-date:” - не часть стандартного набора заголовков :rfc:`2822`. Exim может быть сконфигурирован для её добавления при финальной доставке сообщений. (Смотрите общий транспортный параметр **delivery_date_add**.) Он не должен присутствовать во время пути сообщения. Если установлена конфигурационный параметр **delivery_date_add** (по умолчанию), Exim удаляет заголовки “Delivery-date:” из входящих сообщений.

.. _ch44_10:

Строка заголовка “Envelope-to:”
-------------------------------

Заголовок “Envelope-to:” - не часть стандартного набора заголовков :rfc:`2822`. Exim может быть сконфигурирован для её добавления при финальной доставке сообщений. (Смотрите общий транспортный параметр **envelope_to_add**.) Он не должен присутствовать во время пути сообщения. Если установлен конфигурационный параметр **envelope_to_add** (по умолчанию), Exim удаляет заголовки “Envelope-to:” из входящих сообщений.

.. _ch44_11:

Строка заголовка “From:”
------------------------

Если сообщение в режиме передачи не содержит строки заголовка “From:”, Exim добавляет её если истинно любое из следующих условий:
* Адрес отправителя конверта не пуст (т.е. это - не рикошет). Добавляемая строка заголовка копирует адрес отправителя конверта.
* Сессия SMTP аутентифицирована, и $authenticated_id - не пуст.

  1. Если нет домена, заданного управлением передачей, локальная часть - $authenticated_id, и домен - $qualify_domain.
  2. Если непустой домен задан путём управления передачей, локальная часть - $authenticated_id, и домен - заданный домен.
  3. Если управлением передачей задан пустой домен, предполагается, что в $authenticated_id - полный адрес.

Непустой отправитель конверта обладает приоритетом.

Если входящее, локально порожденное сообщение не содержит строки заголовка “From:”, и настройка **suppress_local_fixups** не задана, Exim добавляет заголовок содержащий адрес отправителя. Логин вызывающего пользователя и его полное имя используются для конструирования адреса, как описано в разделе :ref:`44.18 <ch44_18>`. Оно получаются из данных пароля, путём вызова *getpwuid()* (но, смотрите конфигурацию **unknown_login**). Адрес квалифицируется с **qualify_domain**.

Для совместимости с Sendmail, если приходящее не-SMTP сообщение содержит строку заголовка “From:”, содержащую лишь неквалифицированное имя вызывающего пользователя, она заменяется адресом, содержащим пользовательский логин и полное имя, как описано в разделе :ref:`44.18 <ch44_18>`.

.. _ch44_12:

Строка заголовка “Message-ID:”
------------------------------

Если порожденные локально сообщение, или сообщение в режиме передачи, не имеет заголовка “Message-ID:”, или “Resent-Message-ID:”, и не установлен параметр **suppress_local_fixups**, Exim добавляет подходящий заголовок в сообщение. Если в сообщении есть любой заголовок “Resent-:”, он создаёт “Resent-Message-ID:”. Идентификатор конструируется из внутреннего идентификатора сообщения Exim`a, с предшествующей буквой “E”, для гарантии, что он всегда начинается с буквы, и с и сопровождается "@" и первичным именем хоста. Дополнительная информация может быть включена в эту строку заголовка, путём установки параметра **message_id_header_text** и/или **message_id_header_domain**.

.. _ch44_13:

Строка заголовка “Received:”
----------------------------

Строка заголовка “Received:” добавляется в начале каждого сообщения. Содержимое определяется путём конфигурационного параметра **received_header_text**, и Exim автоматически добавляет точку с запятой и штамп времени в сконфигурированную строку.

Заголовок “Received:” создается как только приходит строка заголовка сообщения. На этом этапе, метка времени в заголовке “Received:” - время начала приёма сообщения. Это значение - то, которое замечено ACL DATA и функцией *local_scan()*.

Как только сообщение принято, временная метка в заголовке “Received:” изменяется на время приёма, которое является (кроме маленькой задержки на запись “-H” файла в спуле) наименьшим временем, когда могла начаться доставка.

.. _ch44_14:

Строка заголовка “References:”
------------------------------

Сообщения созданные транспортом **autoreply** включают заголовок “References:”. Он создаётся   согласно правилам, которые описаны в :rfc:`2822#3.64` (которая заявляет, что ответы должны содержать такую строку заголовка), :rfc:`3834#3.14` (которая заявляет, что автоматические ответы не различаются в этом отношении). Однако, поскольку некоторый программное обеспечение обрабатывающее почту, не очень хорошо справляется с очень длинными строками заголовков, не более чем 12 идентификаторов сообщений копируются из строки заголовка “References:”, входящего сообщения. Если их больше 12-ти, копируются первый, и последующие 11, до добавления идентификатора сообщения для входящего сообщения.

.. _ch44_15:

Строка заголовка “Return-path:”
-------------------------------

Заголовок “Return-path:” задан как нечто, что MTA может вставить, когда производит финальную доставку сообщения. (Смотрите общий транспортный параметр **return_path_add**.) Поэтому, они не должны быть в сообщениях, которые находятся в пути. Если установлена конфигурационный параметр **return_path_remove** (по умолчанию - установлен), Exim удаляет заголовки “Return-path:” из входящих сообщений.

.. _ch44_16:

Строка заголовка “Sender:”
--------------------------

Для локально порожденных сообщений от недоверенных пользователей, Exim может удалять существующий заголовок “Sender:”, и может добавлять новый. Вы можете изменять эти действия, путём установки параметр **local_sender_retain** в истину, **local_from_check** - в ложь, или используя установку **suppress_local_fixups**.

Когда локальное сообщение принимается от недоверенного пользователя, и **local_from_check** - истинна (по умолчанию), и не установлена **suppress_local_fixups**, производиться проверка, что адрес данный в заголовке “From:” - корректный (локальный) отправитель сообщения. Ожидаемый адрес, имеет логин пользователя как локальную часть, и значение **qualify_domain** - как доменную. Преффиксы и суффиксы для локальных частей могут быть разрешены путём установки **local_from_prefix** и **local_from_suffix**, соответственно. Если “From:” не содержит корректного отправителя, к сообщению добавляется строка “Sender:”.

Если вы установите **local_from_check** в ложь, этой проверки не произойдёт. Однако, всё ещё происходит удаление существующей строки “Sender:”, если вы не установили в истину **local_sender_retain**. Невозможно одновременно установить в истину эти два параметра.

По умолчанию, для сообщений полученных по TCP/IP не производиться обработки заголовка “Sender:”, или для сообщений посланных доверенными пользователями. Однако, когда сообщение посылается через TCP/IP в режиме передачи, и для управления передачей не задана **sender_retain**, происходит следующая обработка:

Вначале, удаляются любые существующие строки “Sender:”. Затем, если сессия SMTP аутентифицирована, и $authenticated_id непуста, адрес отправителя создаётся следующим образом:

* Если управлением передачей не задан домен, локальная часть - $authenticated_id, и домен - $qualify_domain.
* Если настройками режима передачи задан непустой домен, локальная часть - $authenticated_id, и домен - заданный домен
* Если настройками режима передачи задан пустой домен, $authenticated_id считается полным адресом.

Этот адрес сравнивается с адресом в заголовке “From:”. Если они различны, добавляется строка “Sender:”, содержащая созданный адрес. Префиксы и суффиксы для локальной части в “From:” могут быть разрешены путём установки **local_from_prefix** и **local_from_suffix**, соответственно.

.. note:: Каждый раз, когда создаётся заголовок “Sender:”, путь возврата сообщения (адрес отправителя конверта) изменяется на тот же самый адрес, исключая случай в режиме передачи, когда задан параметр **sender_retain**.

.. _ch44_17:

Добавление и удаление заголовков в маршрутизаторах и транспортах
----------------------------------------------------------------

Когда сообщение доставляется, дополнение и удаление строк заголовков может быть задано в системном фильтре, или любом маршрутизаторе и транспорте, который обрабатывает сообщение. Раздел :ref:`43.6 <ch43_06>` содержит детали о модификации заголовков в системном фильтре. Строки заголовков, также могут быть добавлены в ACL, при получении сообщения (смотрите раздел :ref:`40.22 <ch40_22>`).

В отличие от того, что происходит в системном фильтре, модификация заголовков заданная в маршрутизаторах и транспортах применяется лишь к специфическим адресам получателей, которые обрабатываются этими маршрутизаторами и транспортами. Эти изменения не актуальны, пока копия сообщения не транспортируется. Поэтому, они не применяются к базовым наборам заголовков, и они не применяются к значениям переменных, которые ссылаются на строки заголовков.

.. note::  В частности, это означает, что любые раскрытия в конфигурации транспорта не могут ссылаться на модифицированные строки заголовков, поскольку эти раскрытия происходят до реальной транспортировки сообщения.

Для обоих, маршрутизаторов и транспортов, результат раскрытия параметра **headers_add** должен быть одной или более строкой заголовков, в соответствии с :rfc:`2822`, разделённых новой строкой (код - “\n”). Например::

    headers_add = X-added-header: added by $primary_hostname\n\
                  X-added-second: another added header line

Exim не проверяет синтаксис этих добавляемых заголовков.

Результат раскрытия **headers_remove** должен состоять из списка имён заголовков разделённых двоеточиями. Это может запутывать, поскольку имена заголовков сами по себе завершаются двоеточием. В этом случае, двоеточие - разделитель списка, а не часть имени. Например::

    headers_remove = return-receipt-to:acknowledge-to

Когда **headers_add** и **headers_remove** заданы в маршрутизаторе, их значения раскрываются во время маршрутизации, и, затем, ассоциируются с каждым адресом, который принимается маршрутизатором, и, также, с любым новым адресом который им создается. Если адрес передаётся через несколько маршрутизаторов, как результат перенаправления или подстановки синонима, изменения накапливаются.

Однако, это не применяется к нескольким маршрутизаторам, как результату использования параметра **unseen**. Любые модификации заголовков, заданные путём маршруризатора **unseen** или его предшественников, применяются лишь к доставке **unseen**.

Адреса, которые заканчиваются различными установками **headers_add** или **headers_remove**, не могут быть доставлены вместе в пакете, таким образом, транспорт всегда имеет дело с рядом адресов, которые имеют теже самые требования к обработке заголовков.

Транспортировка начинается с записи оригинального набора заголовков прибывшего с сообщением, возможно, модифицированного системным фильтром. При выписке этих строк, Exim консультируется со списком имён заголовков которые добавлены адресам получателей путём параметра **headers_remove** в маршрутизаторе, и, также консультируется с транспортным параметром **headers_remove**. Строки заголовков, чьи имена находятся в одном из этих списков - не выписываются. Если есть несколько любых перечисленных заголовков, все они пропускаются.

После записи оставшихся строк оригинальных заголовков, записываются новые строки заголовков, которые заданы параметром маршрутизаторов **headers_add**, в порядке как они были добавлены к адресам. Они сопровождаются любыми строками заголовков заданными транспортным параметром **headers_add**.

Этот способ обработки изменений строк заголовка в маршрутизаторах и транспортах имеет следующие последствия:

* Оригинальный набор заголовков, возможно, модифицированных системным фильтром, остаётся “видимым”, в том смысле, что переменные $header_xxx продолжают на них ссылаться всё время.

* Строки заголовков, которые добавлены параметра **headers_add** маршрутизатора - недоступны посредством синтаксиса раскрытия $header_xxx в последующих маршрутизаторах или транспортах.

* Наоборот, строки заголовков которые определены на удаление путём **headers_remove** в маршрутизаторе, остаются видимы в последующих маршрутизаторах и транспортах.

* Заголовки добавленные к адресу путём **headers_add** в маршрутизаторе не могут быть удалены путём последующих маршрутизаторов или транспортов.

* Добавленные заголовки могут ссылаться на содержимое оригинальных заголовков, которые должны быть удалены, даже если он имеет то же самое имя как и добавляемый заголовок. Например:
  
  ::
  
      headers_remove = subject
      headers_add = Subject: new subject (was: $h_subject:)


.. warning:: Параметры **headers_add** и **headers_remove** не могут использоваться в маршрутизаторе **redirect**, в котором установлен параметр **one_time**.

.. _ch44_18:

Конструирование адресов
-----------------------

Когда Exim создаёт адрес отправителя для локально порожденных сообщений, он использует форму::

    <user name>  <login@qualify_domain>

Например::

    Zaphod Beeblebrox <zaphod@end.univ.example>

Имя пользователя получается из установки **-F** командной строки (если установлено), или, иначе, путём поиска вызвавшего пользователя *getpwuid()* и извлечения поля “gecos” из вхождения пароля. Если поле “gecos” содержит символ “&”, он заменяется на логин с первой буквой в верхнем регистре, как обычно во множестве операционных систем. Смотрите параметр **gecos_name** для способа приспособить обработку поля “gecos”. Параметр **unknown_username** может использоваться для задания имени пользователя в случаях, когда в файле паролей нет вхождения.

Во всех случаях, имя пользователя должно соответствовать :rfc:`2822` путём квотирования всего, или частей, по необходимости. Кроме того, если оно содержит любые непечатаемые символы, оно кодируется как описано в :rfc:`2047`, определяющем способ включения не-ASCII символов в строки заголовков. Значение параметра **headers_charset** задаёт имя кодирования, которое используется (символы, как предполагается, в этой кодировке). Установка **print_topbitchars** контролирует, считать ли символы с установленным высшим битом (т.е., с кодами больше 127) как печатные символы, или нет.

.. _ch44_19:

Регистры локальных частей
-------------------------

:rfc:`2822` устанавливает, что регистр букв в локальных частях не может предполагаться незначащим. Exim сохраняет регистр локальных частей адресов, но, по умолчанию, он использует форму в нижнем регистре, при маршрутизации, поскольку на большинстве UNIX-систем имена пользователей в нижнем регистре, и требуется нечувствительную к регистру маршрутизацию. Однако, любой специфический маршрутизатор можно заставить использовать оригинальный регистр для локальных частей, путём установки общего параметра маршрутизаторов **caseful_local_part**.

Если вам необходимо иметь имена пользователей в смешанном регистре на вашей системе, лучшим способом перейти, предполагая что вы хотите регистронезависимую обработку входящей почты, - установить ваш первый маршрутизатор на преобразование входящих локальных частей в ваших доменах в корректный регистр, путём поиска по файлу. Например::

    correct_case:
      driver = redirect
      domains = +local_domains
      data = ${lookup{$local_part}cdb\
                     {/etc/usercased.cdb}{$value}fail}\
                     @$domain

Для этого маршрутизатора, локальная часть - приводится к нижнему регистру путём действия по умолчанию(**caseful_local_part** - не установлена). Локальная часть в нижнем регистре используется для поиска новой локальной части в корректном регистре. Тогда, если вы установите **caseful_local_part** в любом последующем маршрутизаторе, обрабатывающем ваши домены, то они будут оперировать локальными частями в корректном регистре, в регистрозависимой манере.

.. _ch44_20:

Точки в локальных частях
------------------------

:rfc:`2822` запрещает пустые компоненты в локальных частях. Таким образом, локальная часть не помещенная в кавычки не может начинаться или заканчиваться точкой, или иметь две точки подряд в середине. Однако, кажется, многие MTA не принуждают к этому, таким образом, Exim разрешает пустые компоненты для совместимости.

.. _ch44_21:

Перезапись адресов
------------------

Перезапись адресов отправителей и получателей, и адресов в заголовках, может происходить автоматически, или как результат конфигурационных параметров, как описано в главе :ref:`31 <ch31_00>`. Заголовки, которые могут быть этим затронуты - “Bcc:”, “Cc:”, “From:”, “Reply-To:”, “Sender:” и “To:”.

Автоматическая перезапись включает перезапись, как указано выше. Другой случай, в котором это может случиться - когда дан неполный нелокальный домен. Процесс маршрутизации может вызвать его раскрытие в полное доменное имя. Например, заголовок типа

::

    To: hare@teaparty

мог быть перезаписан как 

::

    To: hare@teaparty.wonderland.fict.example

Перезапись как результат маршрутизации - один из видов обработки сообщений которые не происходят во время прихода сообщения, так как она не может быть сделана до маршрутизации адреса.

Строго, нельзя производить никакие доставки сообщения, пока все адреса не будут маршрутизированы, в случае, если любой заголовок был изменён в результате маршрутизации. Однако, выполнение этого, практически, задержало бы много доставок на чрезмерное время, лишь потому, что один адрес не мог быть немедленно маршрутизирован. Поэтому, Exim не задерживает другие доставки, когда задерживается маршрутизация одного или более адресов.
