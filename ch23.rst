
.. _ch23_00:

Среда для работы локальных транспортов
======================================

Локальные транспорты обрабатывают доставки в файлы и трубы (pipe). (О транспорте **autoreply** можно думать как о доставке в трубу.) Exim всегда выполняет транспорты в субпроцессах, под заданным gid и uid. Типичная доставка в локальные почтовые ящики выполняется под gid и uid локального пользователя.

Также, Exim устанавливает специфическую текущую директорию, когда работает транспорт; для некоторых транспортов, также уместна установка домашней директории. Единственный транспорт, устанавливающий переменные окружения - **pipe**; для получения дополнительных деталей, смотрите раздел :ref:`29.4 <ch29_04>`.

Значение, используемое для uid, gid, и директорий может приходить из нескольких различных мест. Во многих случаях, маршрутизатор, обрабатывающий адрес, ассоциирует настройки этого адреса как результат его параметра **check_local_user**, **group** или **user**. Однако, значения также можно задать в собственной конфигурации транспорта, и они замещают любые приходящие из маршрутизатора.

.. _ch23_01:

Одновременные доставки
----------------------

Если одновременно приходят два различных сообщения, для одного и того же пользователя, то, вероятно, два процесса доставки выполнятся одновременно. Когда для записи в файл используется транспорт **appendfile**, Exim применяет правила блокировки, чтобы помешать одновременным процессам записывать в один файл одновременно.

Однако, когда вы используете транспорт **pipe**, вам решать, как упорядочивать необходимую блокировку. Вот, глупый пример::

    my_transport:
      driver = pipe
      command = /bin/sh -c 'cat >>/some/file'

Он, должен записывать сообщение в конце файла. Однако, если придут два сообщения одновременно, в файле будет свалка. Вы можете использовать утилиту *exim_lock* (смотрите раздел :ref:`50.15 <ch50_15>`), для блокировки файла с использованием того же алгоритма, который использует Exim.

.. _ch23_02:

Uid`ы и gid`ы
-------------

У всех транспортов есть параметр **group** и **user**. Если установлен **group**, он замещает любую группу, заданную маршрутизатором в адресе, даже если для транспорта не задана параметр **user**. Это позволяет, например, производить локальную доставку почты под uid получателя (установленного маршрутизатором), но в специальной группе (установленной транспортом). Например::

    # Routers ...
    # User/group are set by check_local_user in this router
    local_users:
      driver = accept
      check_local_user
      transport = group_delivery

    # Transports ...
    # This transport overrides the group
    group_delivery:
      driver = appendfile
      file = /var/spool/mail/$local_part
      group = mail

Если для транспорта установлен параметр **user**, её значение переопределяет, то, что установлено маршрутизатором в адресе. Если **user** задано не в виде числа, и незадана **group**, gid ассоциируется с используемым пользователем. Если **user** в виде числа, **group** должна быть задана.

Когда uid берётся из конфигурации транспорта, для связанных с этим uid групп вызывается функция *initgroups()*, если для транспорта установлен параметр **initgroups**. Когда uid не задан транспортом, но ассоциирован маршрутизатором с адресом, параметр для вызова *initgroups()* берётся из конфигурации маршрутизатора.

Транспорт **pipe** содержит специальный параметр - **pipe_as_creator**. Если она задана, и не задана **user**, используется uid процесса, вызвавшего Exim для передачи сообщения, и если не задана **group**, также используется оригинальный gid.

Это - предпочтительный детализованный порядок получения gid; используется первый из установленных значений:

* Параметра **group** транспорта;
* Параметра **group** маршрутизатора;
* Gid ассоциированный с пользовательской настройкой маршрутизатора, или как результат **check_local_user**, или явного нечислового значения парамтера **user**;
* Группа, ассоциированная с нечисловым значением параметра **user** транспорта;
* В транспорте **pipe**, gid создателя, если **deliver_as_creator** установлена, и uid - uid создателя;
* Gid Exim`a, если по умолчанию используется uid Exim`a.

Если, например, пользователь определён в маршрутизаторе в цифровой форме, и в нём нет установок группы, нет доступного gid. В этой ситуации, происходит ошибка. Это отличается от uid, для которого всегда есть значение по умолчанию. Используется первая из установленных значний:

* Параметра **user** транспорта;
* В транспорте **pipe**, uid создателя, если установлен параметр **deliver_as_creator**;
* Параметра **user** маршрутизатора;
* Параметра **check_local_user** маршрутизатора;
* Uid Exim`a.

Разумеется, всё равно будет ошибка, если выбранный uid в списке **never_users**.

.. _ch23_03:

Текущая и домашняя директории
-----------------------------

Маршрутизаторы могут устанавливать текущую и домашнюю директории для локальных транспортов путём установки параметра **transport_current_directory** и **transport_home_directory**. Однако, если для транспорта установлены параметры **current_directory** и **home_directory**, они переопределяют значения маршрутизатора. В деталях, домашняя директория для локального транспорта берётся из первого установленного значения:

* Параметра **home_directory**, в транспорте;
* Параметра **transport_home_directory** в маршрутизаторе;
* Данных пароля, если в маршрутизаторе установлена **check_local_user**;
* Параметра **router_home_directory**, в маршрутизаторе.

Текущая директория берётся из первого установленного значения:

* Параметра транспорта **current_directory**;
* Параметра **transport_current_directory**, маршрутизатора.
      
Если ни маршрутизатор, ни транспорт не устанавливают текущую директорию, Exim использует значение домашней директории, если оно установлено. Иначе, до работы локального транспорта, он устанавливает текущую директорию в “/”.

.. _ch23_04:

Переменные раскрытия произведённые из адреса
--------------------------------------------

Обычно, локальная доставка обрабатывает один адрес, и в этом случае, переменные типа $domain и $local_part установлены в течение локальных доставок. Однако, в некоторых обстоятельствах, может быть обработано более одного адреса за раз (например, при записи пакетного SMTP для дальнейшей передачи другими средствами). В этом случае, переменные, ассоциированные с локальной частью, никогда не устанавливаются, $domain устанавливается лишь если адреса имеют одинаковый домен, $original_domain не устанавливается никогда.
